
# Proyecto Final â€“ Arquitectura MLOps Completa
**Autores:** Yibby Gonzalez, Sebastian Ruiz & Adrian Tellez.

Se implementa una arquitectura de MLOps moderna que integra:

- **Airflow** â†’ ingesta, limpieza, split y entrenamiento incremental  
- **MLflow** â†’ tracking de experimentos y artefactos  
- **MinIO + PostgreSQL** â†’ almacenamiento de modelos y metadatos  
- **FastAPI** â†’ servicio de inferencia del modelo  
- **Streamlit** â†’ interfaz visual de predicciÃ³n  
- **Docker Compose** â†’ orquestaciÃ³n local del pipeline  
- **Kubernetes (K3s)** â†’ despliegue en MV javeriana  
- **GitOps (ArgoCD)** â†’ despliegue declarativo y automatizado  
- **PatrÃ³n App-of-Apps** â†’ arquitectura GitOps profesional  
- **CI/CD con GitHub Actions** â†’ construcciÃ³n y publicaciÃ³n de imÃ¡genes  



# Arquitectura General del Proyecto

```
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚      GitHub Repo       â”‚
                                 â”‚   (Infra + Apps GitOps)â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚      ArgoCD         â”‚
                                   â”‚   App-of-Apps       â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Kubernetes Cluster (K3s)                           â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚   FastAPI     â”‚    â”‚  Streamlit   â”‚    â”‚  Monitoring  â”‚                 â”‚
â”‚   â”‚  (Predict)    â”‚<---> UI           â”‚    â”‚Prome + Grafanaâ”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚             â–²                                                             â”‚
â”‚             â”‚  Carga modelo (model.pkl)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Docker Compose                     â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Airflow  â”‚â†’â†’ â”‚ MLflow   â”‚â†’â†’ â”‚   MinIO      â”‚     â”‚
â”‚  â”‚ Pipeline â”‚   â”‚ Tracking â”‚   â”‚  Artefactos â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                                           â”‚
â”‚         â–¼                                           â”‚
â”‚     Genera modelo: model.pkl                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# 1. Kubernetes + GitOps (Completado)

## âœ” Cluster Kubernetes (K3s)
- Instalado en MV javeriana  
- `kubeconfig` configurado  
- Nodo en estado **Ready**

## âœ” ArgoCD instalado y accesible
- InstalaciÃ³n vÃ­a manifiestos oficiales  
- ExposiciÃ³n por port-forward + tÃºnel SSH  
- UI: https://localhost:8000  

## âœ” GitOps conectado a GitHub

Repositorio principal:  
https://github.com/juanruizc1796/mlops-final

## âœ” PatrÃ³n App-of-Apps

```
mlops-final/
â”‚â”€â”€ bootstrap/
â”‚   â”œâ”€â”€ application.yaml
â”‚   â””â”€â”€ apps.yaml
â”‚
â”‚â”€â”€ apps/
â”‚   â”œâ”€â”€ fastapi/
â”‚   â”œâ”€â”€ streamlit/
â”‚   â”œâ”€â”€ prometheus/
â”‚   â”œâ”€â”€ grafana/
â”‚   â”œâ”€â”€ ingress/
â”‚   â”œâ”€â”€ storage/
â”‚   â”œâ”€â”€ database/
â”‚   â””â”€â”€ monitoring/
```

Todas las aplicaciones se crean automÃ¡ticamente desde ArgoCD.

## âœ” Namespaces creados por GitOps
- `fastapi`
- `streamlit`
- `monitoring`
- `database`
- `storage`
- `ingress`


# 2. Docker Compose (Airflow, MLflow, MinIO, PostgreSQL)

Este stack incluye:

| Servicio | FunciÃ³n |
|---------|---------|
| Airflow | Orquesta el pipeline |
| MLflow | Tracking |
| MinIO | Artefactos |
| PostgreSQL | Metadatos |

El cual fue desplegado en la maquina local dado que es la parte del proyecto que requiere de menos computo en comparaciÃ³n a la arquitectura en k8n.

# 3. Pipelines en Airflow

## DAG: `house_price_pipeline`

### âœ” `fetch_chunk`
Descarga datos reales desde:

```
http://10.43.100.103:8000/data?group_number=1&day=Tuesday
```

### âœ” `clean_and_split`
- Limpieza  
- ValidaciÃ³n  
- ConversiÃ³n numÃ©rica  
- ImputaciÃ³n  
- Splits 70/15/15  
- Persistencia por chunk

### âœ” `train_model`
Entrena acumulando todos los chunks.

Registra en MLflow:

- RMSE  
- MAE  
- RÂ²  
- MAPE  
- ParÃ¡metros  
- Artefactos â†’ MinIO

Modelo guardado en:

```
/opt/airflow/data/models/chunk/model.pkl
```


## MLflow Tracking

MLflow almacena:

- mÃ©tricas  
- parÃ¡metros  
- artefactos  
- versiones del modelo  

## Problema con MLflow Model Registry
No se pudo promover modelos a Production debido a un error del Registry.  

**SoluciÃ³n adoptada:**  
FastAPI carga el modelo directamente desde los artefactos locales generados por Airflow.

# Problema conocido: Kubernetes NO puede hacer `docker pull`

La imagen FastAPI estÃ¡ en DockerHub:  
ğŸ‘‰ https://hub.docker.com/repository/docker/juanse1796/fastapi-mlops

Localmente funciona:

```bash
docker pull juanse1796/fastapi-mlops:latest
```

Pero en la MV:

- `ErrImagePull`  
- `ImagePullBackOff`

Las posibles Causas son: Bloqueo institucional,DNS / firewall ,RestricciÃ³n de red , Lo cual afecta parcialmente el desarrollo del despliegue del modelo.


# 4. FastAPI â€“ Servicio de inferencia

âœ” Carga modelo desde `/models/model.pkl`  
âœ” Endpoint `/predict`  
âœ” CI/CD via GitHub Actions  
âœ” DiseÃ±o modular, desacoplado

Flujo:

```
Airflow â†’ modelo.pkl â†’ FastAPI â†’ Streamlit
```


# 5. Streamlit â€“ Interfaz de Usuario

âœ” Permite ingresar variables  
âœ” Llama a FastAPI dentro del cluster  
âœ” Muestra la predicciÃ³n  
âœ” Listo para GitOps  


# 6. Prometheus & Grafana

âœ” Prometheus desplegado  
âœ” Grafana desplegada  
âœ” Datasource â†’ Prometheus  
âœ” Base para monitoreo del sistema MLOps  


# 7. CI/CD â€“ GitHub Actions

Workflow:

```
.github/workflows/build-fastapi.yml
```

Acciones:

- ConstrucciÃ³n automÃ¡tica de imagen  
- PublicaciÃ³n en DockerHub  
- ValidaciÃ³n de YAML  
- Versionado automÃ¡tico  
- Integrado a GitOps  

# Conclusiones

El desarrollo realizado durante este proyecto permitiÃ³ construir una arquitectura MLOps completa, moderna y alineada con las mejores prÃ¡cticas de la industria. Se logrÃ³ integrar exitosamente cada uno de los componentes esenciales del ciclo de vida de un modelo de Machine Learning:

âœ” Entrenamiento incremental y orquestado con Airflow

âœ” Tracking robusto de experimentos con MLflow

âœ” Artefactos versionados y almacenados en MinIO

âœ” Servicio de inferencia mediante FastAPI

âœ” UI de consumo y validaciÃ³n con Streamlit

âœ” Observabilidad con Prometheus y Grafana

âœ” Despliegue continuo y declarativo con GitOps (ArgoCD)

âœ” CI/CD configurado con GitHub Actions

âœ” OperaciÃ³n en Kubernetes (K3s) dentro de una MV universitaria

Este ecosistema reproduce de forma fiel la arquitectura que un equipo de MLOps profesional implementarÃ­a en un entorno, demostrando dominio del pipeline completo: desde la ingesta y transformaciÃ³n de datos, pasando por el entrenamiento y versionamiento de modelos, hasta su despliegue y monitoreo en Kubernetes.

Sin embargo, durante el desarrollo se presentaron limitaciones tÃ©cnicas relevantes, principalmente:

Restricciones de recursos en la mÃ¡quina local y en la MV, lo que afectÃ³ la ejecuciÃ³n fluida de ciertos servicios de Airflow, MLflow y Kubernetes.

Problema persistente de ErrImagePull en la MV, que impidiÃ³ descargar imÃ¡genes desde DockerHub a pesar de que la imagen FastAPI estaba correctamente construida, versionada y accesible desde cualquier otro entorno.

LimitaciÃ³n del MLflow Model Registry, que impidiÃ³ promover modelos a etapas superiores aunque el tracking y registro de artefactos funcionÃ³ de forma correcta.

A pesar de estas restricciones externas, el proyecto cumple en con la arquitectura y los requerimientos funcionales establecidos. 

El flujo MLOps completo(desde el procesamiento incremental de datos hasta su exposiciÃ³n vÃ­a API y UI)queda mapeado, con la salvedad de que los dos problemas mencionados (pull de imÃ¡genes en la MV y Model Registry) impiden cerrar el ciclo de producciÃ³n directamente en el entorno.

No obstante, es importante resaltar que la arquitectura estÃ¡ implementada, y que al resolver estas limitaciones especÃ­ficas del entorno, el pipeline quedarÃ­a funcionando de manera integral, automatizada y continua.

